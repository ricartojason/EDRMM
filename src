The main implementation of the code
